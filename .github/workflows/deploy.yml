name: Monorepo Build & Deploy (changed services)

on:
  push:
    paths:
      - "services/**"
      - "infra/**"
      - ".github/workflows/**"
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.build-matrix.outputs.json }}
      any_changed: ${{ steps.build-matrix.outputs.any }}
    steps:
      - uses: actions/checkout@v4

      - id: filter
        uses: dorny/paths-filter@v3
        with:
          list-files: json
          filters: |
            services:
              - added|modified: "services/**"
            infra_lambroll:
              - added|modified: "infra/lambroll/**"

      - id: build-matrix
        shell: bash
        run: |
          svc_files='${{ steps.filter.outputs.services_files }}'
          lmb_files='${{ steps.filter.outputs.infra_lambroll_files }}'

          {
            # services配下の変更 → services/<name>
            echo "$svc_files" | jq -r '.[]' \
              | awk -F/ '/^services\//{print $1"/"$2}'
            # infra/lambroll配下の変更 → services/<name>
            echo "$lmb_files" | jq -r '.[]' \
              | awk -F/ '/^infra\/lambroll\//{print "services/"$3}'
          } | sort -u | jq -R -s -c 'split("\n") - [""]' > matrix.json

          echo "json=$(cat matrix.json)" >> $GITHUB_OUTPUT
          [ "$(cat matrix.json)" != "[]" ] && echo "any=true"  >> $GITHUB_OUTPUT || echo "any=false" >> $GITHUB_OUTPUT

  build-deploy:
    needs: detect-changes
    if: needs.detect-changes.outputs.any_changed == 'true'
    uses: ./.github/workflows/reusable-build-deploy.yml
    strategy:
      fail-fast: false
      matrix:
        service_dir: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
    with:
      service_dir: ${{ matrix.service_dir }}
    secrets: inherit
    concurrency:
      group: deploy-${{ matrix.service_dir }}
      cancel-in-progress: false
