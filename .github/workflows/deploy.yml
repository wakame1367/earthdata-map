name: Monorepo Build & Deploy (changed services)

on:
  push:
    paths:
      - "services/**"
      - "infra/**"
      - ".github/workflows/**"
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.build-matrix.outputs.json }}
      any_changed: ${{ steps.build-matrix.outputs.any }}
    steps:
      - uses: actions/checkout@v4

      - id: filter
        uses: dorny/paths-filter@v3
        with:
          list-files: json
          filters: |
            services:
              - added|modified: "services/**"

      - id: build-matrix
        run: |
          files='${{ steps.filter.outputs.svc_files }}'
          # å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ«ãƒ¼ãƒˆ "services/<name>" ã‚’æŠ½å‡º
          # ä¾‹: services/earthdata-asset-resolver/app/handler.py -> services/earthdata-asset-resolver
          echo "$files" | jq -r '.[]' \
            | awk -F/ '/^services\//{print $1"/"$2}' \
            | sort -u | jq -R -s -c 'split("\n") - [""]' > matrix.json
          echo "json=$(cat matrix.json)" >> $GITHUB_OUTPUT
          [ "$(cat matrix.json)" != "[]" ] && echo "any=true"  >> $GITHUB_OUTPUT || echo "any=false" >> $GITHUB_OUTPUT

  build-deploy:
    needs: detect-changes
    if: needs.detect-changes.outputs.any_changed == 'true'
    # ğŸŸ¢ ã“ã“ã‚’ â€œjob ãƒ¬ãƒ™ãƒ« usesâ€ ã«å¤‰æ›´
    uses: ./.github/workflows/reusable-build-deploy.yml
    strategy:
      fail-fast: false
      matrix:
        service_dir: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
    with:
      service_dir: ${{ matrix.service_dir }}
      # ecr_repo / lambroll_dir ã¯æ¸¡ã•ãšã«ã€å‘¼ã°ã‚Œã‚‹å´ã§å°å‡ºã•ã›ã‚‹
    secrets: inherit
    concurrency:
      group: deploy-${{ matrix.service_dir }}
      cancel-in-progress: false
